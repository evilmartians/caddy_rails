{
  {{env "CADDY_GLOBAL_OPTIONS"}}
  serve-rails bin/rails s -p {{or (env "CADDY_BACKEND_PORT") .BackendPort}}
  {{if or (env "CADDY_DEBUG") .Debug}}debug{{end}}
  {{if or (env "CADDY_ACCESS_LOG") .AccessLog}}log{{end}}
}

http://{{or (env "CADDY_HTTP_HOST") .HttpHost}}:{{or (env "CADDY_HTTP_PORT") .HttpPort}} {
  root * ./public
  @notStatic {
    not {
      file {
        try_files {path}
      }
    }
  }

  {{if or (env "CADDY_ENABLE_COMPRESSION") .EnableCompression}}
  encode br gzip zstd
  {{end}}

  reverse_proxy @notStatic {
    to localhost:{{or (env "CADDY_BACKEND_PORT") .BackendPort}}

    header_up X-Real-IP {remote_host}
    header_up X-Forwarded-Proto {scheme}
    header_up Access-Control-Allow-Origin *
    header_up Access-Control-Allow-Credentials true
    header_up Access-Control-Allow-Headers Cache-Control,Content-Type
    transport http {
      read_buffer 8192
    }
  }

  file_server
}

{{if or (env "CADDY_HTTPS_ENABLE") .HttpsEnable}}
https://{{if (env "CADDY_SSL_DOMAIN")}}{{env "CADDY_SSL_DOMAIN"}}{{else if .SSLDomain}}{{.SSLDomain}}{{else}}{{.HttpHost}}{{end}} {
  tls internal
  root * ./public
  @notStatic {
    not {
      file {
        try_files {path}
      }
    }
  }

  {{if or (env "CADDY_ENABLE_COMPRESSION") .EnableCompression}}
  encode gzip zstd
  {{end}}

  reverse_proxy @notStatic {
    to localhost:{{or (env "CADDY_BACKEND_PORT") .BackendPort}}

    header_up X-Real-IP {remote_host}
    header_up X-Forwarded-Proto {scheme}
    header_up Access-Control-Allow-Origin *
    header_up Access-Control-Allow-Credentials true
    header_up Access-Control-Allow-Headers Cache-Control,Content-Type
    transport http {
      read_buffer 8192
    }
  }

  file_server
}
{{end}}
